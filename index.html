<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İclas Otağı Rezervasiya Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .lang-flag { cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
        .lang-flag.active { opacity: 1; border: 2px solid #3b82f6; border-radius: 50%; }
        #connection-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: background-color 0.5s ease;
        }
        .status-connected { background-color: #22c55e; } /* green-500 */
        .status-disconnected { background-color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div id="app-container" class="relative w-full max-w-6xl h-[90vh] mx-auto bg-[#0D1117] rounded-2xl shadow-2xl flex overflow-hidden">
        
        <!-- Language Switcher Panel -->
        <div id="lang-switcher" class="absolute top-4 right-6 flex items-center space-x-3 z-10">
            <svg data-lang="az" class="lang-flag h-6 w-6 rounded-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 9 6"><path fill="#3F9C35" d="M0 4h9v2H0z"/><path fill="#DA0000" d="M0 2h9v2H0z"/><path fill="#00B5E2" d="M0 0h9v2H0z"/><path fill="#fff" d="M4.2 2.5a.5.5 0 01.3.1l.1.1a.5.5 0 010 .6.5.5 0 01-.8 0 .5.5 0 010-.6l.1-.1a.5.5 0 01.3-.1z"/><path fill="#fff" d="M5.2 3l-.4-.2-.3.3.1-.4-.4-.2h.5l.1-.4.2.4h.5l-.4.2.1.4z"/></svg>
            <svg data-lang="en" class="lang-flag h-6 w-6 rounded-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30"><clipPath id="a"><path d="M0 0v30h60V0z"/></clipPath><path d="M0 0v30h60V0z" fill="#012169"/><path d="M0 0l60 30m0-30L0 30" stroke="#fff" stroke-width="6"/><path d="M0 0l60 30m0-30L0 30" clip-path="url(#a)" stroke="#C8102E" stroke-width="4"/><path d="M30 0v30M0 15h60" stroke="#fff" stroke-width="10"/><path d="M30 0v30M0 15h60" stroke="#C8102E" stroke-width="6"/></svg>
            <svg data-lang="ru" class="lang-flag h-6 w-6 rounded-full" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 9 6"><path fill="#fff" d="M0 0h9v3H0z"/><path fill="#d52b1e" d="M0 3h9v3H0z"/><path fill="#0039a6" d="M0 2h9v2H0z"/></svg>
        </div>

        <!-- Left Panel -->
        <div id="left-panel" class="w-1/3 bg-green-800 p-8 flex flex-col justify-between transition-colors duration-500">
            <div>
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                         <svg class="w-8 h-8" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4h6v6H4V4zm0 10h6v6H4v-6zM14 4h6v6h-6V4zm0 10h6v6h-6v-6z" fill="currentColor"></path></svg>
                         <span class="text-2xl font-bold">BitcoiN</span>
                    </div>
                     <div id="connection-status" class="status-disconnected" title="Server Connection Status"></div>
                </div>
                <h1 id="room-name" class="text-6xl font-bold mt-16">Yüklənir...</h1>
                <div id="current-meeting-info" class="mt-8 h-32"></div>
            </div>
            <div>
                <p id="current-time" class="text-5xl font-semibold">00:00:00</p>
                <p id="user-display-name" class="text-gray-300 mt-2 text-lg">İstifadəçi: Gözlənilir...</p>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="w-2/3 bg-[#0D1117] p-8 flex flex-col">
            <div id="timeline" class="relative flex-grow overflow-y-auto no-scrollbar"></div>
            <div class="flex gap-4 pt-6 border-t border-gray-700">
                <button id="book-now-btn" data-translate="bookNow" class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-bold py-4 rounded-lg">İndi Rezerv Et</button>
                <button id="find-room-btn" data-translate="selectRoom" class="w-full bg-gray-700 hover:bg-gray-600 transition-colors text-white font-bold py-4 rounded-lg">Otaq Seç</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="user-setup-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
        <div class="bg-[#161B22] p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6" data-translate="welcome">Xoş Gəlmisiniz!</h2>
            <p class="text-gray-300 mb-4" data-translate="enterYourName">Zəhmət olmasa, ad və soyadınızı daxil edin.</p>
            <form id="user-setup-form">
                <input type="text" id="user-name-input" data-translate-placeholder="fullName" placeholder="Ad, Soyad" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <button type="submit" data-translate="save" class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-bold py-3 rounded-lg">Yadda Saxla</button>
            </form>
        </div>
    </div>

    <div id="booking-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-[#161B22] p-8 rounded-2xl shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6" data-translate="newBooking">Yeni Rezervasiya</h2>
            <form id="booking-form">
                <div class="mb-4">
                    <label for="meeting-title" class="block text-sm font-medium text-gray-300 mb-2" data-translate="meetingTitle">İclasın Adı</label>
                    <input type="text" id="meeting-title" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="user-name-booking" class="block text-sm font-medium text-gray-300 mb-2" data-translate="fullName">Ad, Soyad</label>
                    <input type="text" id="user-name-booking" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="start-time" class="block text-sm font-medium text-gray-300 mb-2" data-translate="startTime">Başlama Saatı</label>
                        <input type="time" id="start-time" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label for="duration" class="block text-sm font-medium text-gray-300 mb-2" data-translate="duration">Müddəti (dəqiqə)</label>
                        <input type="number" id="duration" value="60" min="15" step="15" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="pin-code" class="block text-sm font-medium text-gray-300 mb-2" data-translate="pinForCancel">Ləğv Etmək üçün 4 Rəqəmli PIN</label>
                    <input type="password" id="pin-code" pattern="\d{4}" data-translate-title="pinTitle" title="4 rəqəmli PIN daxil edin" maxlength="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="flex gap-4">
                    <button type="button" id="cancel-booking-btn" data-translate="cancel" class="w-full bg-gray-600 hover:bg-gray-500 transition-colors text-white font-bold py-3 rounded-lg">Ləğv Et</button>
                    <button type="submit" data-translate="book" class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-bold py-3 rounded-lg">Rezerv Et</button>
                </div>
            </form>
        </div>
    </div>

    <div id="pin-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-[#161B22] p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6" data-translate="enterPin">PIN Daxil Edin</h2>
            <form id="pin-form">
                <input type="password" id="pin-input" maxlength="4" class="w-full text-center text-2xl tracking-[1em] bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <div class="flex gap-4">
                    <button type="button" id="pin-cancel-btn" data-translate="cancel" class="w-full bg-gray-600 hover:bg-gray-500 transition-colors text-white font-bold py-3 rounded-lg">Ləğv Et</button>
                    <button type="submit" data-translate="confirm" class="w-full bg-blue-600 hover:bg-blue-700 transition-colors text-white font-bold py-3 rounded-lg">Təsdiq Et</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="room-list-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-[#161B22] p-8 rounded-2xl shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6" data-translate="selectRoom">Otağı Seçin</h2>
            <div id="room-list-container" class="space-y-3"></div>
            <button type="button" id="close-room-list-btn" data-translate="close" class="w-full mt-6 bg-gray-600 hover:bg-gray-500 transition-colors text-white font-bold py-3 rounded-lg">Bağla</button>
        </div>
    </div>
    
    <div id="alert-box" class="fixed top-5 right-5 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg hidden transition-opacity duration-300 z-50">
        <p id="alert-message"></p>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-[#161B22] p-8 rounded-2xl shadow-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4" id="confirm-title">Əminsiniz?</h2>
            <p class="text-gray-300 mb-6" id="confirm-message"></p>
            <div class="flex gap-4">
                <button type="button" id="confirm-cancel-btn" data-translate="cancel" class="w-full bg-gray-600 hover:bg-gray-500 transition-colors text-white font-bold py-3 rounded-lg">Ləğv Et</button>
                <button type="button" id="confirm-ok-btn" data-translate="yesCancelIt" class="w-full bg-red-600 hover:bg-red-700 transition-colors text-white font-bold py-3 rounded-lg">Bəli, Ləğv Et</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION ---
            const ADMIN_USER_ID = 'turko';

            // --- TRANSLATION OBJECT ---
            const translations = {
                az: {
                    user: "İstifadəçi", admin: "Admin", loading: "Yüklənir...", waiting: "Gözlənilir...", bookNow: "İndi Rezerv Et", selectRoom: "Otağı Seçin", welcome: "Xoş Gəlmisiniz!", enterYourName: "Zəhmət olmasa, ad və soyadınızı daxil edin.", fullName: "Ad, Soyad", save: "Yadda Saxla", newBooking: "Yeni Rezervasiya", meetingTitle: "İclasın Adı", startTime: "Başlama Saatı", duration: "Müddəti (dəqiqə)", pinForCancel: "Ləğv Etmək üçün 4 Rəqəmli PIN", pinTitle: "4 rəqəmli PIN daxil edin", cancel: "Ləğv Et", book: "Rezerv Et", enterPin: "PIN Daxil Edin", confirm: "Təsdiq Et", close: "Bağla", areYouSure: "Əminsiniz?", yesCancelIt: "Bəli, Ləğv Et", roomEmpty: "Otaq Boşdur", organizer: "Təşkilatçı", endNow: "İndi Bitir",
                    alertInvalidDuration: "Müddət 15 dəqiqədən az ola bilməz.", alertOverlap: "Seçilmiş vaxtda artıq rezervasiya mövcuddur.", alertPinIncorrect: "PIN kod səhvdir!", alertConnectionLost: "Serverlə əlaqə kəsildi. Səhifəni yeniləyin.",
                    confirmCancelBookingTitle: "Rezervasiyanı Ləğv Et", confirmCancelBookingMsg: "Bu rezervasiyanı ləğv etmək istədiyinizə əminsiniz?", confirmEndMeetingTitle: "İclası Bitir", confirmEndMeetingMsg: "Bu iclası indi bitirmək istədiyinizə əminsiniz?",
                    noServerAddress: "Server ünvanı tapılmadı. Zəhmət olmasa, düzgün şəbəkəyə qoşulduğunuzdan əmin olun."
                },
                en: {
                    user: "User", admin: "Admin", loading: "Loading...", waiting: "Waiting...", bookNow: "Book Now", selectRoom: "Select Room", welcome: "Welcome!", enterYourName: "Please enter your first and last name.", fullName: "Full Name", save: "Save", newBooking: "New Booking", meetingTitle: "Meeting Title", startTime: "Start Time", duration: "Duration (minutes)", pinForCancel: "4-Digit PIN to Cancel", pinTitle: "Enter a 4-digit PIN", cancel: "Cancel", book: "Book", enterPin: "Enter PIN", confirm: "Confirm", close: "Close", areYouSure: "Are you sure?", yesCancelIt: "Yes, Cancel It", roomEmpty: "Room is Available", organizer: "Organizer", endNow: "End Now",
                    alertInvalidDuration: "Duration cannot be less than 15 minutes.", alertOverlap: "The selected time is already booked.", alertPinIncorrect: "Incorrect PIN code!", alertConnectionLost: "Connection to the server was lost. Please refresh the page.",
                    confirmCancelBookingTitle: "Cancel Booking", confirmCancelBookingMsg: "Are you sure you want to cancel this booking?", confirmEndMeetingTitle: "End Meeting", confirmEndMeetingMsg: "Are you sure you want to end this meeting now?",
                    noServerAddress: "Server address not found. Please ensure you are connected to the correct network."
                },
                ru: {
                    user: "Пользователь", admin: "Админ", loading: "Загрузка...", waiting: "Ожидание...", bookNow: "Забронировать", selectRoom: "Выбрать комнату", welcome: "Добро пожаловать!", enterYourName: "Пожалуйста, введите ваше имя и фамилию.", fullName: "Имя, Фамилия", save: "Сохранить", newBooking: "Новое бронирование", meetingTitle: "Название встречи", startTime: "Время начала", duration: "Продолжительность (минуты)", pinForCancel: "4-значный PIN для отмены", pinTitle: "Введите 4-значный PIN", cancel: "Отмена", book: "Забронировать", enterPin: "Введите PIN", confirm: "Подтвердить", close: "Закрыть", areYouSure: "Вы уверены?", yesCancelIt: "Да, отменить", roomEmpty: "Комната свободна", organizer: "Организатор", endNow: "Завершить сейчас",
                    alertInvalidDuration: "Продолжительность не может быть меньше 15 минут.", alertOverlap: "Выбранное время уже забронировано.", alertPinIncorrect: "Неверный PIN-код!", alertConnectionLost: "Соединение с сервером потеряно. Пожалуйста, обновите страницу.",
                    confirmCancelBookingTitle: "Отменить бронирование", confirmCancelBookingMsg: "Вы уверены, что хотите отменить это бронирование?", confirmEndMeetingTitle: "Завершить встречу", confirmEndMeetingMsg: "Вы уверены, что хотите завершить эту встречу сейчас?",
                    noServerAddress: "Адрес сервера не найден. Убедитесь, что вы подключены к правильной сети."
                }
            };
            
            // --- STATE VARIABLES ---
            let ROOM_ID = null;
            let currentUserId = null;
            let currentUserName = null;
            let currentLang = 'az';
            let appData = {};
            let ws;
            let hasScrolledToCurrentTime = false;

            // --- DOM ELEMENTS CACHE ---
            const allElements = {
                leftPanel: document.getElementById('left-panel'),
                userDisplayName: document.getElementById('user-display-name'),
                userSetupModal: document.getElementById('user-setup-modal'),
                userSetupForm: document.getElementById('user-setup-form'),
                pinModal: document.getElementById('pin-modal'),
                pinForm: document.getElementById('pin-form'),
                currentTime: document.getElementById('current-time'),
                timeline: document.getElementById('timeline'),
                currentMeetingInfo: document.getElementById('current-meeting-info'),
                roomName: document.getElementById('room-name'),
                bookingModal: document.getElementById('booking-modal'),
                bookNowBtn: document.getElementById('book-now-btn'),
                cancelBookingBtn: document.getElementById('cancel-booking-btn'),
                bookingForm: document.getElementById('booking-form'),
                findRoomBtn: document.getElementById('find-room-btn'),
                alertBox: document.getElementById('alert-box'),
                alertMessage: document.getElementById('alert-message'),
                roomListModal: document.getElementById('room-list-modal'),
                roomListContainer: document.getElementById('room-list-container'),
                closeRoomListBtn: document.getElementById('close-room-list-btn'),
                langSwitcher: document.getElementById('lang-switcher'),
                connectionStatus: document.getElementById('connection-status'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmTitle: document.getElementById('confirm-title'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmOkBtn: document.getElementById('confirm-ok-btn'),
                confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
            };

            // --- LANGUAGE & TRANSLATION ---
            function setLanguage(lang) {
                currentLang = lang;
                localStorage.setItem('meetingRoomLanguage', lang);
                document.documentElement.lang = lang;
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    el.textContent = translations[lang]?.[key] || key;
                });
                document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                    const key = el.getAttribute('data-translate-placeholder');
                    el.placeholder = translations[lang]?.[key] || key;
                });
                document.querySelectorAll('[data-translate-title]').forEach(el => {
                    const key = el.getAttribute('data-translate-title');
                    el.title = translations[lang]?.[key] || key;
                });
                allElements.langSwitcher.querySelectorAll('.lang-flag').forEach(flag => {
                    flag.classList.toggle('active', flag.dataset.lang === lang);
                });
                renderAll(); 
            }
            
            // --- WEBSOCKET CONNECTION ---
            function connectWebSocket() {
                const host = window.location.host;
                if (!host) {
                    console.error("Server address not found. Cannot establish WebSocket connection.");
                    allElements.connectionStatus.classList.remove('status-connected');
                    allElements.connectionStatus.classList.add('status-disconnected');
                    allElements.connectionStatus.title = "Server ünvanı tapılmadı";
                    showAlert('noServerAddress');
                    return;
                }

                ws = new WebSocket('ws://' + host);

                ws.onopen = () => {
                    console.log('Successfully connected to the server.');
                    allElements.connectionStatus.classList.remove('status-disconnected');
                    allElements.connectionStatus.classList.add('status-connected');
                    allElements.connectionStatus.title = "Connected";
                };

                ws.onmessage = (event) => {
                    try {
                        const { type, payload } = JSON.parse(event.data);
                        if (type === 'initial' || type === 'update') {
                            updateAndRender(payload);
                        } else if (type === 'error' && payload.message === 'PIN incorrect') {
                            showAlert('alertPinIncorrect');
                        }
                    } catch (e) {
                        console.error("Failed to process message from server:", e);
                    }
                };

                ws.onclose = () => {
                    console.log('Connection to server lost...');
                    allElements.connectionStatus.classList.remove('status-connected');
                    allElements.connectionStatus.classList.add('status-disconnected');
                    allElements.connectionStatus.title = "Connection lost. Please refresh.";
                    showAlert('alertConnectionLost');
                    setTimeout(connectWebSocket, 5000);
                };

                ws.onerror = (error) => console.error('WebSocket error:', error);
            }
            
            // --- DATA & RENDERING ---
            function updateAndRender(data) {
                appData = data;
                renderAll();
                if (!hasScrolledToCurrentTime) {
                    scrollToCurrentTime();
                    hasScrolledToCurrentTime = true;
                }
            }

            function renderAll() {
                if (!appData || !appData.rooms || !appData.rooms[ROOM_ID]) {
                    allElements.roomName.textContent = translations[currentLang]?.loading || "Loading...";
                    allElements.currentMeetingInfo.innerHTML = '';
                    document.querySelectorAll('.booking-block').forEach(el => el.remove());
                    return;
                }
                const room = appData.rooms[ROOM_ID];
                allElements.roomName.textContent = room.name;
                const today = new Date().toISOString().split('T')[0];
                const bookingsData = room.bookings || [];
                const bookings = bookingsData
                    .map(b => ({ ...b, startTime: new Date(b.startTime), endTime: new Date(b.endTime) }))
                    .filter(b => b.startTime instanceof Date && !isNaN(b.startTime) && b.startTime.toISOString().split('T')[0] === today)
                    .sort((a, b) => a.startTime - b.startTime);
                
                renderBookings(bookings);
                updateCurrentMeeting(bookings); 
                initializeUser();
            }

            function renderBookings(bookings) {
                document.querySelectorAll('.booking-block').forEach(el => el.remove());
                bookings.forEach(booking => {
                    const { id, title, userName, startTime, endTime, userId } = booking;
                    const top = (startTime.getHours() * 96) + (startTime.getMinutes() / 60 * 96);
                    const durationMinutes = (endTime - startTime) / 60000;
                    const height = (durationMinutes / 60) * 96;
                    if (height <= 0) return;

                    const cursorClass = (userId === currentUserId || currentUserId === ADMIN_USER_ID) ? 'cursor-pointer' : 'cursor-default';
                    
                    const bookingDiv = document.createElement('div');
                    bookingDiv.dataset.id = id;
                    bookingDiv.className = `booking-block absolute left-20 right-0 p-4 rounded-lg flex flex-col justify-between ${cursorClass}`;
                    bookingDiv.style.top = `${top}px`;
                    bookingDiv.style.height = `${height}px`;
                    bookingDiv.style.backgroundColor = userId === currentUserId ? '#1E40AF' : '#991B1B';
                    bookingDiv.innerHTML = `<div><h3 class="font-bold text-white">${title || ''}</h3><p class="text-sm text-gray-300">${userName || ''}</p></div><p class="text-sm text-gray-200 self-end">${startTime.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' })} - ${endTime.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' })}</p>`;
                    allElements.timeline.appendChild(bookingDiv);
                });
            }

            function updateCurrentMeeting(bookings) {
                const now = new Date();
                const currentMeeting = bookings.find(b => now >= b.startTime && now < b.endTime);
                
                if (currentMeeting) {
                    allElements.leftPanel.classList.remove('bg-green-800');
                    allElements.leftPanel.classList.add('bg-red-800');
                } else {
                    allElements.leftPanel.classList.remove('bg-red-800');
                    allElements.leftPanel.classList.add('bg-green-800');
                }

                allElements.currentMeetingInfo.innerHTML = '';
                if (currentMeeting) {
                    let buttonsHtml = '';
                    if (currentMeeting.userId === currentUserId || currentUserId === ADMIN_USER_ID) {
                        buttonsHtml = `<div class="flex gap-3 mt-4"><button data-id="${currentMeeting.id}" class="end-now-btn bg-green-600 hover:bg-green-700 text-base font-semibold px-4 py-2 rounded-md">${translations[currentLang]?.endNow || 'End Now'}</button></div>`;
                    }
                    allElements.currentMeetingInfo.innerHTML = `<p class="text-3xl font-semibold text-white">${currentMeeting.title}</p><p class="text-xl text-gray-200 mt-2">${currentMeeting.startTime.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' })} - ${currentMeeting.endTime.toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit' })}</p><p class="text-lg text-gray-300 mt-1">${translations[currentLang]?.organizer || 'Organizer'}: ${currentMeeting.userName}</p>${buttonsHtml}`;
                } else {
                    allElements.currentMeetingInfo.innerHTML = `<p class="text-3xl font-semibold text-white">${translations[currentLang]?.roomEmpty || 'Room is Available'}</p>`;
                }
            }

            // --- USER LOGIC ---
            function initializeUser() {
                currentUserName = localStorage.getItem('meetingRoomUserName');
                currentUserId = localStorage.getItem('meetingRoomUserId');

                if (!currentUserName || !currentUserId) {
                    allElements.userSetupModal.classList.remove('hidden');
                } else {
                    const userTypeKey = currentUserId === ADMIN_USER_ID ? 'admin' : 'user';
                    const userType = translations[currentLang]?.[userTypeKey] || userTypeKey;
                    allElements.userDisplayName.textContent = `${userType}: ${currentUserName}`;
                }

                if (!currentUserId) {
                    currentUserId = 'user-' + Date.now() + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('meetingRoomUserId', currentUserId);
                }
            }

            // --- BOOKING LOGIC ---
            function sendToServer(message) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(message));
                } else {
                    showAlert('alertConnectionLost');
                }
            }

            function addBooking(title, userName, startTimeStr, durationMinutes, pin) {
                if (durationMinutes < 15) {
                    showAlert('alertInvalidDuration');
                    return;
                }
                const today = new Date();
                const [hours, minutes] = startTimeStr.split(':');
                const newStart = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);

                const newEnd = new Date(newStart.getTime() + durationMinutes * 60000);

                const bookingsData = appData.rooms?.[ROOM_ID]?.bookings || [];
                const bookings = bookingsData.map(b => ({ ...b, startTime: new Date(b.startTime), endTime: new Date(b.endTime) }));
                const isOverlapping = bookings.some(b => newStart < b.endTime && newEnd > b.startTime);
                if (isOverlapping) {
                    showAlert('alertOverlap');
                    return;
                }

                const newBooking = { id: 'booking-' + Date.now() + Math.random().toString(36).substr(2, 9), title, userName, startTime: newStart.toISOString(), endTime: newEnd.toISOString(), userId: currentUserId, pin };
                sendToServer({ type: 'addBooking', payload: { roomId: ROOM_ID, booking: newBooking } });
                
                allElements.bookingModal.classList.add('hidden');
                allElements.bookingForm.reset();
            }

            function handleBookingAction(bookingId, action) {
                const bookingsData = appData.rooms?.[ROOM_ID]?.bookings || [];
                const booking = bookingsData.find(b => b.id === bookingId);
                if (!booking) return;

                if (currentUserId === ADMIN_USER_ID) {
                    if (action === 'delete') showConfirm('confirmCancelBookingTitle', 'confirmCancelBookingMsg', () => sendToServer({ type: 'deleteBooking', payload: { roomId: ROOM_ID, bookingId, userId: currentUserId } }));
                    else if (action === 'end_now') showConfirm('confirmEndMeetingTitle', 'confirmEndMeetingMsg', () => sendToServer({ type: 'endMeeting', payload: { roomId: ROOM_ID, bookingId, userId: currentUserId } }));
                    return;
                }

                if (booking.userId !== currentUserId) return;
                
                showPinModal((pin) => {
                    if (action === 'delete') sendToServer({ type: 'deleteBooking', payload: { roomId: ROOM_ID, bookingId, userId: currentUserId, pin } });
                    else if (action === 'end_now') sendToServer({ type: 'endMeeting', payload: { roomId: ROOM_ID, bookingId, userId: currentUserId, pin } });
                });
            }

            // --- UI FUNCTIONS & HELPERS ---
            function showAlert(translationKey) {
                const message = translations[currentLang]?.[translationKey] || translationKey;
                allElements.alertMessage.textContent = message;
                allElements.alertBox.classList.remove('hidden');
                setTimeout(() => allElements.alertBox.classList.add('hidden'), 3000);
            }

            function showConfirm(titleKey, messageKey, onOk) {
                allElements.confirmTitle.textContent = translations[currentLang]?.[titleKey] || titleKey;
                allElements.confirmMessage.textContent = translations[currentLang]?.[messageKey] || messageKey;
                allElements.confirmModal.classList.remove('hidden');
                
                const newOkBtn = allElements.confirmOkBtn.cloneNode(true);
                allElements.confirmOkBtn.parentNode.replaceChild(newOkBtn, allElements.confirmOkBtn);
                allElements.confirmOkBtn = newOkBtn;
                allElements.confirmOkBtn.textContent = translations[currentLang]?.yesCancelIt || "Yes, Cancel It";
                
                const newCancelBtn = allElements.confirmCancelBtn.cloneNode(true);
                allElements.confirmCancelBtn.parentNode.replaceChild(newCancelBtn, allElements.confirmCancelBtn);
                allElements.confirmCancelBtn = newCancelBtn;
                allElements.confirmCancelBtn.textContent = translations[currentLang]?.cancel || "Cancel";

                allElements.confirmOkBtn.addEventListener('click', () => { onOk(); allElements.confirmModal.classList.add('hidden'); });
                allElements.confirmCancelBtn.addEventListener('click', () => allElements.confirmModal.classList.add('hidden'));
            }

            function showPinModal(callback) {
                allElements.pinModal.classList.remove('hidden');
                const pinInput = allElements.pinForm.querySelector('input');
                pinInput.focus();
                pinInput.value = '';
                allElements.pinForm.onsubmit = (e) => {
                    e.preventDefault();
                    callback(pinInput.value);
                    allElements.pinModal.classList.add('hidden');
                };
                document.getElementById('pin-cancel-btn').onclick = () => {
                    allElements.pinModal.classList.add('hidden');
                };
            }

            function updateClock() {
                allElements.currentTime.textContent = new Date().toLocaleTimeString('az-AZ', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            }

            function renderTimeline() {
                allElements.timeline.innerHTML = '';
                for (let i = 0; i <= 23; i++) { // Render full 24 hours
                    const hourDiv = `<div class="relative flex items-start h-24"><div class="w-20 text-right pr-4 text-sm text-gray-400">${i.toString().padStart(2, '0')}:00</div><div class="flex-grow border-t border-gray-700 mt-2"></div></div>`;
                    allElements.timeline.innerHTML += hourDiv;
                }
            }

            function scrollToCurrentTime() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();

                // Each hour is 96px (h-24)
                const scrollPosition = (currentHour * 96) + (currentMinute / 60 * 96);
                
                // Scroll to 1 hour before the current time for context
                const offset = 96; 
                
                allElements.timeline.scrollTop = Math.max(0, scrollPosition - offset);
            }

            function renderRoomList() {
                if (!appData.rooms) return;
                allElements.roomListContainer.innerHTML = '';
                const roomIds = Object.keys(appData.rooms).sort();
                roomIds.forEach(roomId => {
                    const room = appData.rooms[roomId];
                    const roomLink = document.createElement('a');
                    roomLink.href = `?room=${roomId}`;
                    roomLink.className = 'block w-full text-left p-4 rounded-lg transition-colors bg-gray-700 hover:bg-gray-600';
                    roomLink.textContent = room.name;
                    allElements.roomListContainer.appendChild(roomLink);
                });
            }

            // --- EVENT LISTENERS ---
            function addEventListeners() {
                allElements.userSetupForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const userNameInput = document.getElementById('user-name-input');
                    currentUserName = userNameInput.value.trim();
                    if (currentUserName) {
                        localStorage.setItem('meetingRoomUserName', currentUserName);
                        initializeUser();
                        allElements.userSetupModal.classList.add('hidden');
                    }
                });

                allElements.bookNowBtn.addEventListener('click', () => {
                    document.getElementById('user-name-booking').value = currentUserName || '';
                    const now = new Date();
                    
                    const minutes = now.getMinutes();
                    const roundedMinutes = Math.floor(minutes / 15) * 15;
                    now.setMinutes(roundedMinutes);
                    now.setSeconds(0);
                    now.setMilliseconds(0);
                    
                    document.getElementById('start-time').value = now.toTimeString().substring(0, 5);
                    document.getElementById('duration').value = 60; 
                    allElements.bookingModal.classList.remove('hidden');
                });

                allElements.cancelBookingBtn.addEventListener('click', () => allElements.bookingModal.classList.add('hidden'));
                allElements.bookingModal.addEventListener('click', (e) => { if (e.target === allElements.bookingModal) allElements.bookingModal.classList.add('hidden'); });

                allElements.bookingForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const title = e.target.querySelector('#meeting-title').value;
                    const userName = e.target.querySelector('#user-name-booking').value;
                    const start = e.target.querySelector('#start-time').value;
                    const duration = parseInt(e.target.querySelector('#duration').value, 10);
                    const pin = e.target.querySelector('#pin-code').value;
                    
                    addBooking(title, userName, start, duration, pin);
                });

                document.addEventListener('click', (e) => {
                    const targetEl = e.target;
                    const endNowBtn = targetEl.closest('.end-now-btn');
                    const bookingBlock = targetEl.closest('.booking-block');

                    if (endNowBtn) {
                        handleBookingAction(endNowBtn.dataset.id, 'end_now');
                    } else if (bookingBlock) {
                        handleBookingAction(bookingBlock.dataset.id, 'delete');
                    }
                });

                allElements.findRoomBtn.addEventListener('click', () => {
                    renderRoomList();
                    allElements.roomListModal.classList.remove('hidden');
                });
                allElements.closeRoomListBtn.addEventListener('click', () => allElements.roomListModal.classList.add('hidden'));
                allElements.roomListModal.addEventListener('click', (e) => { if (e.target === allElements.roomListModal) allElements.roomListModal.classList.add('hidden'); });
                
                allElements.langSwitcher.addEventListener('click', (e) => {
                    const flag = e.target.closest('.lang-flag');
                    if (flag) {
                        setLanguage(flag.dataset.lang);
                    }
                });
            }

            // --- INITIALIZATION ---
            function init() {
                ROOM_ID = new URLSearchParams(window.location.search).get('room') || 'buta';
                const savedLang = localStorage.getItem('meetingRoomLanguage') || 'az';
                
                renderTimeline();
                updateClock();
                setInterval(updateClock, 1000);
                
                setLanguage(savedLang); 
                initializeUser();
                addEventListeners();
                connectWebSocket();
            }

            init();
        });
    </script>
</body>
</html>


